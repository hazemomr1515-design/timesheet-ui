<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Timesheet Mock</title>

    <!-- React + ReactDOM (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel لتشغيل JSX مباشرة على المتصفح -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>

    <!-- Ant Design (UMD) + CSS ثابت -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5/dist/reset.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5/dist/antd.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/antd@5/dist/antd.min.js"></script>

    <!-- dayjs -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <!-- i18next + react-i18next (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-i18next@13/dist/umd/react-i18next.production.min.js"></script>

    <style>
      body { padding: 24px; background:#f5f5f5; }
      .container { max-width: 1200px; margin: 0 auto; }
      .ant-layout { background: #fff; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- App -->
    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;
      const { ConfigProvider, Layout, Typography, Space, Segmented, Input, Select, Table, Button, InputNumber, Checkbox, theme, message } = antd;
      const { initReactI18next, useTranslation } = window['reactI18next'];

      // Init i18n
      i18next.use(initReactI18next).init({
        resources: {
          ar: { translation: {
            appTitle:'نموذج التايم شيت', language:'اللغة', arabic:'عربي', english:'English',
            entityCode:'كود الجهة', entityType:'نوع الجهة', entityName:'اسم الجهة',
            project:'المشروع', activity:'النشاط', hours:'الساعات', billable:'مفوترة', overtime:'وقت إضافي',
            comment:'ملاحظة', addRow:'إضافة صف', remove:'حذف', summary:'الملخص', totalWeek:'إجمالي الأسبوع',
            sun:'الأحد', mon:'الإثنين', tue:'الثلاثاء', wed:'الأربعاء', thu:'الخميس'
          }},
          en: { translation: {
            appTitle:'Timesheet Mock', language:'Language', arabic:'Arabic', english:'English',
            entityCode:'Entity Code', entityType:'Entity Type', entityName:'Entity Name',
            project:'Project', activity:'Activity', hours:'Hours', billable:'Billable', overtime:'Overtime',
            comment:'Comment', addRow:'Add Row', remove:'Remove', summary:'Summary', totalWeek:'Total Week',
            sun:'Sun', mon:'Mon', tue:'Tue', wed:'Wed', thu:'Thu'
          }}
        },
        lng: 'ar', fallbackLng: 'en', interpolation: { escapeValue: false }
      });

      const PROJECTS = [
        'Government Payment System','Payroll','Hyperion','Cash Collection','GOV-POS',
        'مشروع التحصيل الإلكتروني للمصروفات الجامعية','Core Taxation','E-Receipt','Time Entries'
      ];
      const dayKeys = ['sun','mon','tue','wed','thu'];
      const activities = ['Development','Support','Meeting','Training','Analysis','Testing'];

      function useRTL(lang){ useEffect(()=>{ document.dir = lang==='ar'?'rtl':'ltr'; document.documentElement.lang = lang; },[lang]); }

      async function loadEntities() {
        try {
          const res = await fetch('./entities.csv'); // نفس جذر الريبو
          if (!res.ok) return [];
          const text = await res.text();
          const [headerLine, ...rows] = text.split(/\r?\n/).filter(Boolean);
          const header = headerLine.split(',');
          const idx = {
            code: header.findIndex(h=>h.trim().toLowerCase()==='code'),
            type: header.findIndex(h=>h.trim().toLowerCase()==='type'),
            name: header.findIndex(h=>h.trim().toLowerCase()==='name')
          };
          return rows.map(l=>{ const p=l.split(','); return {code:p[idx.code]?.trim()||'', type:p[idx.type]?.trim()||'', name:p[idx.name]?.trim()||''};}).filter(x=>x.code);
        } catch { return []; }
      }

      function App(){
        const { t, i18n } = useTranslation();
        const [lang, setLang] = useState('ar'); useRTL(lang);
        const [rows, setRows] = useState([{ key: Math.random().toString(36).slice(2), project: undefined, activity: undefined, days: {sun:{},mon:{},tue:{},wed:{},thu:{}} }]);
        const [entities, setEntities] = useState([]);
        const [entityCode, setEntityCode] = useState(''); const [entityType, setEntityType] = useState(''); const [entityName, setEntityName] = useState('');

        useEffect(()=>{ i18n.changeLanguage(lang); },[lang]);
        useEffect(()=>{ loadEntities().then(setEntities); },[]);
        useEffect(()=>{ if(!entityCode){ setEntityType(''); setEntityName(''); return; } const f=entities.find(e=>e.code===entityCode); setEntityType(f?.type||''); setEntityName(f?.name||''); },[entityCode,entities]);

        function updateRow(k, patch){ setRows(r=>r.map(x=>x.key===k?{...x,...patch}:x)); }
        function updateCell(k, d, patch){ setRows(r=>r.map(x=>x.key!==k?x:{...x, days:{...x.days, [d]:{...x.days[d], ...patch}}})); }
        function addRow(){ setRows(r=>[...r,{ key: Math.random().toString(36).slice(2), project: undefined, activity: undefined, days:{sun:{},mon:{},tue:{},wed:{},thu:{}} }]); }
        function removeRow(k){ setRows(r=>r.filter(x=>x.key!==k)); }

        const columns = React.useMemo(()=>{
          const dayCols = dayKeys.map(dk=>({
            title: t(dk), key: dk, width: 180,
            render: (_, rec) => {
              const cell = rec.days[dk] || {};
              return (
                <Space direction="vertical" size={4} style={{ width: 160 }}>
                  <InputNumber style={{ width: '100%' }} min={0} step={0.5} placeholder={t('hours')} value={cell.hours}
                    onChange={(v)=>updateCell(rec.key, dk, { hours: Number(v??0) })} />
                  <Space size={8}>
                    <Checkbox checked={!!cell.billable} onChange={e=>updateCell(rec.key,dk,{billable:e.target.checked})}>{t('billable')}</Checkbox>
                    <Checkbox checked={!!cell.overtime} onChange={e=>updateCell(rec.key,dk,{overtime:e.target.checked})}>{t('overtime')}</Checkbox>
                  </Space>
                  <Input.TextArea rows={1} placeholder={t('comment')} value={cell.comment} onChange={e=>updateCell(rec.key,dk,{comment:e.target.value})}/>
                </Space>
              );
            }
          }));
          return [
            { title: t('project'), dataIndex:'project', width: 260, render: (_ , rec) => (
              <Select style={{ width: 240 }} showSearch placeholder={t('project')} value={rec.project}
                onChange={(v)=>updateRow(rec.key, { project: v })}
                options={PROJECTS.map(p=>({label:p, value:p}))}/>
            )},
            { title: t('activity'), dataIndex:'activity', width: 180, render: (_ , rec) => (
              <Select style={{ width: 160 }} placeholder={t('activity')} value={rec.activity}
                onChange={(v)=>updateRow(rec.key, { activity: v })}
                options={['Development','Support','Meeting','Training','Analysis','Testing'].map(a=>({label:a, value:a}))}/>
            )},
            ...dayCols,
            { title:'', key:'actions', width:100, fixed:'right', render: (_ , rec) => (<Button danger onClick={()=>removeRow(rec.key)}>{t('remove')}</Button>) }
          ];
        }, [lang]);

        const totalWeek = useMemo(()=> rows.reduce((s,r)=> s + dayKeys.reduce((x,d)=> x + (r.days[d]?.hours || 0),0),0), [rows]);
        const isRTL = lang === 'ar';

        return (
          <div className="container">
            <ConfigProvider direction={isRTL?'rtl':'ltr'} theme={{ algorithm: theme.defaultAlgorithm }}>
              <Layout style={{ minHeight: '100vh', padding: 24 }}>
                <Typography.Title level={3}>{t('appTitle')}</Typography.Title>

                <Space align="center" wrap size="large" style={{ marginBottom: 16 }}>
                  <Space>
                    <Typography.Text strong>{t('language')}</Typography.Text>
                    <Segmented value={lang} onChange={(v)=>setLang(v)} options={[
                      {label:t('arabic'), value:'ar'}, {label:t('english'), value:'en'}
                    ]}/>
                  </Space>

                  <Space>
                    <Typography.Text strong>{t('entityCode')}</Typography.Text>
                    <Input style={{ width: 160 }} value={entityCode} onChange={(e)=>setEntityCode(e.target.value)} placeholder="مثال: 101" />
                  </Space>
                  <Space>
                    <Typography.Text strong>{t('entityType')}</Typography.Text>
                    <Input style={{ width: 220 }} value={entityType} readOnly />
                  </Space>
                  <Space>
                    <Typography.Text strong>{t('entityName')}</Typography.Text>
                    <Input style={{ width: 320 }} value={entityName} readOnly />
                  </Space>
                </Space>

                <div style={{ marginBottom: 12 }}>
                  <Button type="primary" onClick={addRow}>{t('addRow')}</Button>
                </div>

                <Table dataSource={rows} columns={columns} pagination={false} scroll={{ x: 1200 }} rowKey="key" />

                <div style={{ marginTop: 16 }}>
                  <Typography.Title level={4}>{t('summary')}</Typography.Title>
                  <Typography.Text>{t('totalWeek')}: {totalWeek}</Typography.Text>
                </div>
              </Layout>
            </ConfigProvider>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
